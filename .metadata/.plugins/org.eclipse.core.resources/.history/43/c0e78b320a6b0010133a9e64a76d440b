package com.ishika.foodwaste.jpa.entityManager;

import java.util.List;

import org.springframework.stereotype.Repository;

import com.ishika.foodwaste.jpa.entity.DeliveryPerson;
import com.ishika.foodwaste.jpa.entity.FoodDonation;

import jakarta.persistence.EntityManager;
import jakarta.persistence.NoResultException;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.TypedQuery;
@Repository
public class DeliveryPersonManager {
	   @PersistenceContext
	    private EntityManager em;

	    // ✅ Get unassigned orders in a specific city
	    public List<FoodDonation> getUnassignedOrders(String city) {
	        try {
	            TypedQuery<FoodDonation> query = em.createQuery(
	                "SELECT f FROM FoodDonation f WHERE f.assignedTo IS NOT NULL AND f.deliveryBy IS NULL AND f.location = :city",
	                FoodDonation.class
	            );
	            query.setParameter("city", city);
	            return query.getResultList();
	        } catch (Exception e) {
	            e.printStackTrace();
	            return null;
	        }
	    }

	    // ✅ Get orders assigned to this delivery person
	    public List<FoodDonation> getOrdersByDeliveryPerson(int deliveryPersonId) {
	        try {
	            TypedQuery<FoodDonation> query = em.createQuery(
	                "SELECT f FROM FoodDonation f WHERE f.deliveryBy = :deliveryPersonId",
	                FoodDonation.class
	            );
	            query.setParameter("deliveryPersonId", deliveryPersonId);
	            return query.getResultList();
	        } catch (Exception e) {
	            e.printStackTrace();
	            return null;
	        }
	    }

	    // ✅ Assign delivery to current delivery person (if not already assigned)
	    public boolean takeOrder(int orderId, int deliveryPersonId) {
	        try {
	            FoodDonation order = em.find(FoodDonation.class, orderId);

	            if (order.getDeliveryBy() != null) {
	                // Already assigned
	                return false;
	            }

	            em.getTransaction().begin();
	            order.setDeliveryBy(deliveryPersonId);
	            em.merge(order);
	            em.getTransaction().commit();
	            return true;
	        } catch (Exception e) {
	            e.printStackTrace();
	            em.getTransaction().rollback();
	            return false;
	        }
	    }
	    
	    public DeliveryPerson findByEmail(String email) {
	        try {
	            TypedQuery<DeliveryPerson> query = em.createQuery(
	                "SELECT d FROM DeliveryPerson d WHERE d.email = :email",
	                DeliveryPerson.class
	            );
	            query.setParameter("email", email);
	            return query.getSingleResult();
	        } catch (NoResultException e) {
	            return null; // Not found
	        } catch (Exception e) {
	            e.printStackTrace();
	            return null;
	        }
	    }
}
